name: Mean cicd pipeline

on:
  push:
    branches: [ main ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # Frontend: Install, Test, build
    - name: Frontend - Install
      working-directory: ./frontend
      run: npm ci
      
    - name: Frontend - Test
      working-directory: ./frontend
      run: npm run test
    
    - name: Frontend - Build
      working-directory: ./frontend
      run: npm run build
      
    # Backend: Install, Test, Build 
    - name: Backend - Install
      working-directory: ./backend
      run: npm ci
      
    - name: Backend - Test
      working-directory: ./backend
      run: npm test
      
    # # Docker Login & Build/Push (only on main push)
    # - name: Docker Login
    #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKERHUB_USERNAME }}
    #     password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    # - name: Build & Push Frontend
    #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    #   uses: docker/build-push-action@v6
    #   with:
    #     context: ./frontend
    #     push: true
    #     tags: ${{ secrets.DOCKERHUB_USERNAME }}/mean-frontend:latest,${{ secrets.DOCKERHUB_USERNAME }}/mean-frontend:${{ github.sha }}
    
    # - name: Build & Push Backend
    #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    #   uses: docker/build-push-action@v6
    #   with:
    #     context: ./backend
    #     push: true
    #     tags: ${{ secrets.DOCKERHUB_USERNAME }}/mean-backend:latest,${{ secrets.DOCKERHUB_USERNAME }}/mean-backend:${{ github.sha }}
    
    # - name: Build & Push Mongo (optional)
    #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    #   run: |
    #     docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mean-mongo:latest -f Dockerfile.mongo .
    #     docker push ${{ secrets.DOCKERHUB_USERNAME }}/mean-mongo:latest